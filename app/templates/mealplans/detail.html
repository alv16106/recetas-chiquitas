{% extends "base.html" %}

{% block title %}{{ meal_plan.name }} - Plan de comidas{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="mb-1">{{ meal_plan.name }}</h1>
        <p class="text-muted mb-0">Duración: {{ meal_plan.duration_days }} días</p>
    </div>
    <div class="d-flex gap-2">
        <a href="{{ url_for('mealplans.edit', id=meal_plan.id) }}" class="btn btn-outline-primary">Editar</a>
        <form method="post" action="{{ url_for('mealplans.create_shopping_list', id=meal_plan.id) }}" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-success">Crear lista de compras</button>
        </form>
        <form method="post" action="{{ url_for('mealplans.delete', id=meal_plan.id) }}" class="d-inline"
              onsubmit="return confirm('¿Seguro que quieres eliminar este plan?');">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <button type="submit" class="btn btn-outline-danger">Eliminar</button>
        </form>
    </div>
</div>

<div class="mb-4">
    <label for="mealplan-recipe-search" class="form-label">Añadir receta al plan</label>
    <div class="position-relative">
        <input type="search" id="mealplan-recipe-search" class="form-control" placeholder="Buscar por nombre, ingrediente o etiqueta..." autocomplete="off">
        <div id="mealplan-search-results" class="list-group position-absolute w-100 mt-1" style="z-index: 10; display: none; max-height: 280px; overflow-y: auto;"></div>
    </div>
</div>

{% if meal_plan.recipes.count() %}
<h4>Recetas en este plan</h4>
<ul class="list-group mb-3">
    {% for mpr in meal_plan.recipes %}
    <li class="list-group-item d-flex justify-content-between align-items-center mealplan-recipe-item" data-recipe-id="{{ mpr.recipe.id }}">
        <div class="flex-grow-1">
            <a href="{{ url_for('recipes.detail', id=mpr.recipe.id) }}" class="text-decoration-none">
                {{ mpr.recipe.title }}
            </a>
            {% if mpr.recipe.tags %}
            <div class="mt-1">
                {% for tag in mpr.recipe.tags %}
                <span class="badge recipe-tag me-1">{{ tag.name }}</span>
                {% endfor %}
            </div>
            {% endif %}
        </div>
        <div class="d-flex align-items-center gap-1">
            <div class="btn-group btn-group-sm" role="group">
                <button type="button" class="btn btn-outline-secondary mealplan-count-dec" data-plan-id="{{ meal_plan.id }}" data-recipe-id="{{ mpr.recipe.id }}" title="Menos">−</button>
                <span class="btn btn-outline-secondary px-2 mealplan-count-display" style="min-width: 2rem;">{{ mpr.count }}</span>
                <button type="button" class="btn btn-outline-secondary mealplan-count-inc" data-plan-id="{{ meal_plan.id }}" data-recipe-id="{{ mpr.recipe.id }}" title="Más">+</button>
            </div>
            <button type="button" class="btn btn-outline-danger btn-sm mealplan-remove-recipe" data-plan-id="{{ meal_plan.id }}" data-recipe-id="{{ mpr.recipe.id }}" title="Quitar">×</button>
        </div>
    </li>
    {% endfor %}
</ul>
{% else %}
<p class="text-muted">Aún no hay recetas en este plan. Usa la búsqueda de arriba para añadir.</p>
{% endif %}

<p class="text-muted small">También puedes añadir recetas desde el detalle de cada receta con "Añadir al plan de comidas".</p>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
(function() {
    var searchEl = document.getElementById('mealplan-recipe-search');
    var resultsEl = document.getElementById('mealplan-search-results');
    var planId = {{ meal_plan.id }};
    var debounceTimer;
    var addedIds = new Set([{% for mpr in meal_plan.recipes %}{{ mpr.recipe.id }}{% if not loop.last %}, {% endif %}{% endfor %}]);

    searchEl.addEventListener('input', function() {
        clearTimeout(debounceTimer);
        var q = searchEl.value.trim();
        resultsEl.style.display = 'none';
        resultsEl.innerHTML = '';
        if (q.length < 1) return;
        debounceTimer = setTimeout(function() {
            fetch('/api/recipes?q=' + encodeURIComponent(q) + '&limit=15')
                .then(function(r) { return r.json(); })
                .then(function(recipes) {
                    resultsEl.innerHTML = '';
                    recipes.forEach(function(r) {
                        var li = document.createElement('div');
                        li.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                        var a = document.createElement('a');
                        a.href = '/recipes/' + r.id;
                        a.className = 'text-decoration-none flex-grow-1';
                        a.textContent = r.title;
                        li.appendChild(a);
                        if (addedIds.has(r.id)) {
                            var span = document.createElement('span');
                            span.className = 'badge bg-secondary';
                            span.textContent = 'En el plan';
                            li.appendChild(span);
                        } else {
                            var form = document.createElement('form');
                            form.method = 'post';
                            form.action = '/mealplans/' + planId + '/add-recipe';
                            form.className = 'd-inline';
                            form.innerHTML = '<input type="hidden" name="csrf_token" value="{{ csrf_token() }}"><input type="hidden" name="recipe_id" value="' + r.id + '"><button type="submit" class="btn btn-sm btn-success">Añadir</button>';
                            li.appendChild(form);
                        }
                        resultsEl.appendChild(li);
                    });
                    if (recipes.length) resultsEl.style.display = 'block';
                });
        }, 200);
    });
    searchEl.addEventListener('blur', function() { setTimeout(function() { resultsEl.style.display = 'none'; }, 200); });

    var csrf = document.querySelector('input[name="csrf_token"]');
    function setCount(planId, recipeId, delta) {
        var row = document.querySelector('.mealplan-recipe-item[data-recipe-id="' + recipeId + '"]');
        var display = row ? row.querySelector('.mealplan-count-display') : null;
        var current = display ? parseInt(display.textContent, 10) || 1 : 1;
        var next = Math.max(1, current + delta);
        fetch('/mealplans/' + planId + '/set-recipe-count/' + recipeId, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json',
                'X-CSRFToken': csrf ? csrf.value : ''
            },
            body: 'csrf_token=' + encodeURIComponent(csrf ? csrf.value : '') + '&count=' + next
        }).then(function(r) {
            if (r.ok && display) display.textContent = next;
        });
    }
    document.querySelectorAll('.mealplan-count-inc').forEach(function(btn) {
        btn.addEventListener('click', function() {
            setCount(btn.dataset.planId, parseInt(btn.dataset.recipeId, 10), 1);
        });
    });
    document.querySelectorAll('.mealplan-count-dec').forEach(function(btn) {
        btn.addEventListener('click', function() {
            setCount(btn.dataset.planId, parseInt(btn.dataset.recipeId, 10), -1);
        });
    });
    document.querySelectorAll('.mealplan-remove-recipe').forEach(function(btn) {
        btn.addEventListener('click', function() {
            var planId = btn.dataset.planId;
            var recipeId = parseInt(btn.dataset.recipeId, 10);
            var row = btn.closest('.mealplan-recipe-item');
            fetch('/mealplans/' + planId + '/remove-recipe/' + recipeId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrf ? csrf.value : ''
                },
                body: 'csrf_token=' + encodeURIComponent(csrf ? csrf.value : '')
            }).then(function(r) {
                if (r.ok) {
                    addedIds.delete(recipeId);
                    row.remove();
                }
            });
        });
    });
})();
</script>
{% endblock %}
