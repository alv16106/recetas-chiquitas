{% extends "base.html" %}

{% block title %}{{ 'Editar receta' if recipe else 'Nueva receta' }} - Recetas Chiquitas{% endblock %}

{% block content %}
<h1>{{ 'Editar receta' if recipe else 'Nueva receta' }}</h1>

{% if not recipe %}
<div class="card mb-4">
    <div class="card-body">
        <h6 class="card-title">Importar desde URL</h6>
        <p class="card-text small text-muted">Pega el enlace de una receta de una web de cocina para rellenar título, instrucciones e ingredientes (en texto). Luego puedes ajustar y normalizar los ingredientes.</p>
        <div class="input-group">
            <input type="url" id="import-recipe-url" class="form-control" placeholder="https://...">
            <button type="button" id="import-recipe-btn" class="btn btn-outline-primary">Importar</button>
        </div>
        <div id="import-recipe-error" class="invalid-feedback d-none"></div>
    </div>
</div>
{% endif %}

<form method="post" enctype="multipart/form-data" novalidate>
    {{ form.hidden_tag() }}

    <div class="mb-3">
        {{ form.title.label(class="form-label") }}
        {{ form.title(class="form-control" + (" is-invalid" if form.title.errors else "")) }}
        {% if form.title.errors %}
        <div class="invalid-feedback">{{ form.title.errors[0] }}</div>
        {% endif %}
    </div>
    <div class="mb-3">
        {{ form.description.label(class="form-label") }}
        {{ form.description(class="form-control", rows=2) }}
    </div>
    <div class="mb-3">
        {{ form.instructions.label(class="form-label") }}
        {{ form.instructions(class="form-control", rows=6) }}
    </div>
    <div class="mb-3">
        {{ form.tags.label(class="form-label") }}
        {{ form.tags(class="form-control", placeholder="postre, fácil, vegano, ...") }}
    </div>

    <h5>Ingredientes</h5>
    <div id="ingredients-container" class="mb-3" data-new-recipe="{{ 'true' if not recipe else 'false' }}">
        {% if recipe %}
        {% for ri in recipe.ingredients %}
        <div class="ingredient-row row g-2 mb-2 align-items-center">
            <div class="col-md-2">
                <input type="text" name="ingredient_quantity" class="form-control" placeholder="Cantidad" value="{{ ri.quantity }}">
            </div>
            <div class="col-md-2">
                <select name="ingredient_unit_id" class="form-control form-select ingredient-unit-select">
                    <option value="">—</option>
                    {% for u in units %}
                    <option value="{{ u.id }}" {% if ri.unit_id == u.id %}selected{% endif %}>{{ u.symbol or u.name }}</option>
                    {% endfor %}
                </select>
                <input type="hidden" name="ingredient_unit" value="">
            </div>
            <div class="col-md-6 position-relative">
                <input type="text" name="ingredient_name" class="form-control ingredient-autocomplete" placeholder="Buscar o añadir ingrediente" value="{{ ri.ingredient.name if ri.ingredient else '' }}" required autocomplete="off">
                <div class="ingredient-suggestions list-group position-absolute w-100" style="z-index: 10; display: none;"></div>
            </div>
            <div class="col-md-1">
                <label class="form-check-label small" title="Opcional">
                    <input type="checkbox" name="ingredient_optional" value="{{ loop.index0 }}" class="ingredient-optional-cb" {% if ri.optional %}checked{% endif %}> Opc.
                </label>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-outline-danger btn-remove-ingredient">−</button>
            </div>
        </div>
        {% endfor %}
        {% endif %}
    </div>
    <button type="button" id="add-ingredient" class="btn btn-outline-secondary btn-sm mb-4">+ Añadir ingrediente</button>

    <h5>Imágenes</h5>
    {% if recipe and recipe.images.count() > 0 %}
    <div class="mb-3">
        {% for img in recipe.images %}
        <div class="d-inline-block me-2 mb-2 position-relative">
            <img src="{{ url_for('recipes.serve_image', recipe_id=recipe.id, filename=img.filename) }}"
                 class="img-thumbnail" style="height: 80px; width: auto;">
            <label class="position-absolute top-0 start-0 m-1">
                <input type="checkbox" name="remove_image" value="{{ img.id }}"> Quitar
            </label>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    <div class="mb-3">
        <input type="file" name="images" class="form-control" multiple accept="image/*">
    </div>

    {{ form.submit(class="btn btn-primary") }}
    <a href="{{ url_for('recipes.detail', id=recipe.id) if recipe else url_for('recipes.list') }}" class="btn btn-secondary">Cancelar</a>
</form>

<template id="ingredient-row-template">
    <div class="ingredient-row row g-2 mb-2 align-items-center">
        <div class="col-md-2">
            <input type="text" name="ingredient_quantity" class="form-control" placeholder="Cantidad">
        </div>
        <div class="col-md-2">
            <select name="ingredient_unit_id" class="form-control form-select ingredient-unit-select">
                <option value="">—</option>
                {% for u in units %}
                <option value="{{ u.id }}">{{ u.symbol or u.name }}</option>
                {% endfor %}
            </select>
            <input type="hidden" name="ingredient_unit" value="">
        </div>
        <div class="col-md-6 position-relative">
            <input type="text" name="ingredient_name" class="form-control ingredient-autocomplete" placeholder="Buscar o añadir ingrediente" required autocomplete="off">
            <div class="ingredient-suggestions list-group position-absolute w-100" style="z-index: 10; display: none;"></div>
        </div>
        <div class="col-md-1 ingredient-optional-cell">
            <label class="form-check-label small" title="Opcional">
                <input type="checkbox" name="ingredient_optional" value="" class="ingredient-optional-cb"> Opc.
            </label>
        </div>
        <div class="col-md-1">
            <button type="button" class="btn btn-outline-danger btn-remove-ingredient">−</button>
        </div>
    </div>
</template>

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const container = document.getElementById('ingredients-container');
    const template = document.getElementById('ingredient-row-template');
    const addBtn = document.getElementById('add-ingredient');
    var debounceTimer;

    addBtn.onclick = function() {
        const row = template.content.cloneNode(true);
        container.appendChild(row);
        attachAutocomplete(container.querySelector('.ingredient-row:last-child .ingredient-autocomplete'));
    };

    container.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-ingredient')) {
            e.target.closest('.ingredient-row').remove();
        }
    });

    function attachAutocomplete(input) {
        if (!input || input.dataset.autocompleteAttached) return;
        input.dataset.autocompleteAttached = '1';
        var suggestionsEl = input.closest('.position-relative').querySelector('.ingredient-suggestions');
        input.addEventListener('input', function() {
            clearTimeout(debounceTimer);
            var q = input.value.trim();
            suggestionsEl.style.display = 'none';
            suggestionsEl.innerHTML = '';
            if (q.length < 2) return;
            debounceTimer = setTimeout(function() {
                fetch('/api/ingredients?q=' + encodeURIComponent(q) + '&limit=10')
                    .then(function(r) { return r.json(); })
                    .then(function(items) {
                        suggestionsEl.innerHTML = '';
                        items.forEach(function(item) {
                            var a = document.createElement('a');
                            a.href = '#';
                            a.className = 'list-group-item list-group-item-action';
                            a.textContent = item.name;
                            a.addEventListener('click', function(e) {
                                e.preventDefault();
                                input.value = item.name;
                                suggestionsEl.style.display = 'none';
                            });
                            suggestionsEl.appendChild(a);
                        });
                        if (items.length) suggestionsEl.style.display = 'block';
                    });
            }, 200);
        });
        input.addEventListener('blur', function() {
            setTimeout(function() { suggestionsEl.style.display = 'none'; }, 150);
        });
        input.addEventListener('focus', function() {
            if (suggestionsEl.children.length) suggestionsEl.style.display = 'block';
        });
    }

    container.querySelectorAll('.ingredient-autocomplete').forEach(attachAutocomplete);

    document.querySelector('form').addEventListener('submit', function() {
        container.querySelectorAll('.ingredient-row').forEach(function(row, idx) {
            var cb = row.querySelector('.ingredient-optional-cb');
            if (cb) cb.value = idx;
        });
    });

    var isNewRecipe = container.dataset.newRecipe === 'true';
    if (isNewRecipe && !document.querySelector('.ingredient-row')) addBtn.click();

    var importBtn = document.getElementById('import-recipe-btn');
    var importUrl = document.getElementById('import-recipe-url');
    var importError = document.getElementById('import-recipe-error');
    if (importBtn && importUrl) {
        importBtn.onclick = function() {
            var url = importUrl.value.trim();
            if (!url) return;
            importError.classList.add('d-none');
            importError.textContent = '';
            importBtn.disabled = true;
            var csrf = document.querySelector('input[name="csrf_token"]');
            fetch('{{ url_for("recipes.import_from_url") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json',
                    'X-CSRFToken': csrf ? csrf.value : ''
                },
                body: JSON.stringify({ url: url })
            }).then(function(r) {
                return r.json().then(function(data) {
                    if (!r.ok) throw new Error((data.error || 'Error al importar') + (data.detail ? ' — ' + data.detail : ''));
                    return data;
                });
            }).then(function(data) {
                if (data.title) document.querySelector('input[name="title"]').value = data.title;
                if (data.instructions) document.querySelector('textarea[name="instructions"]').value = data.instructions;
                container.querySelectorAll('.ingredient-row').forEach(function(row) { row.remove(); });
                var list = data.ingredients && data.ingredients.length ? data.ingredients : [''];
                list.forEach(function(text) {
                    var row = template.content.cloneNode(true);
                    container.appendChild(row);
                    var nameInput = container.querySelector('.ingredient-row:last-child .ingredient-autocomplete');
                    nameInput.value = typeof text === 'string' ? text : '';
                    attachAutocomplete(nameInput);
                });
                importUrl.value = '';
            }).catch(function(err) {
                importError.textContent = err.message || 'Error al importar';
                importError.classList.remove('d-none');
            }).finally(function() {
                importBtn.disabled = false;
            });
        };
    }
});
</script>
{% endblock %}
{% endblock %}
